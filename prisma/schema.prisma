// Houseiana Unified Fullstack - Prisma Schema
// This schema defines the database structure for the unified Next.js application
// Database: PostgreSQL (Vercel Postgres, Neon, or any PostgreSQL provider)

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["fullTextSearch"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                       String      @id @default(cuid())
  firstName                String
  lastName                 String
  email                    String?     @unique
  password                 String?
  phone                    String?
  countryCode              String?
  userType                 UserType    @default(GUEST)
  isAdmin                  Boolean     @default(false)
  profilePhoto             String?
  birthDate                String?
  isPhoneVerified          Boolean     @default(false)
  isHost                   Boolean     @default(false)
  memberSince              DateTime    @default(now())
  emailVerified            Boolean     @default(false)
  phoneVerified            Boolean     @default(false)
  travelPoints             Int         @default(0)
  loyaltyTier              String      @default("Bronze")
  idNumber                 String?
  idCopy                   String?
  kycCompleted             Boolean     @default(false)
  avatar                   String?
  passwordResetToken       String?
  passwordResetExpires     DateTime?
  emailVerificationToken   String?
  emailVerificationExpires DateTime?
  failedLoginAttempts      Int         @default(0)
  accountLockedUntil       DateTime?
  lastLoginAt              DateTime?
  createdAt                DateTime    @default(now())
  updatedAt                DateTime    @updatedAt
  accounts                 Account[]
  otpCodes                 OtpCode[]
  referrals                Referral[]
  sessions                 Session[]
  properties               Property[]
  bookings                 Booking[]
  reviews                  Review[]
  favorites                Favorite[]
  complaints               Complaint[]
  chatConversations        ChatConversation[]
  accountActions           AccountAction[]

  @@map("users")
}

model Referral {
  id        String   @id @default(cuid())
  userId    String
  code      String   @unique
  usedBy    String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("referrals")
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  refreshToken String?  @unique
  expiresAt    DateTime
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model OtpCode {
  id        String   @id @default(cuid())
  userId    String?
  phone     String?
  email     String?
  code      String
  type      OtpType
  expiresAt DateTime
  verified  Boolean  @default(false)
  attempts  Int      @default(0)
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("otp_codes")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

enum UserType {
  HOST
  GUEST
  ADMIN
}

enum OtpType {
  PHONE_VERIFICATION
  EMAIL_VERIFICATION
  LOGIN
  PASSWORD_RESET
}

// Property & Booking Models
model Property {
  id              String           @id @default(cuid())
  hostId          String
  title           String
  description     String           @db.Text
  propertyType    PropertyType
  roomType        RoomType

  // Location
  country         String
  city            String
  state           String?
  address         String
  zipCode         String?
  latitude        Float?
  longitude       Float?

  // Capacity
  guests          Int
  bedrooms        Int
  beds            Int
  bathrooms       Float

  // Pricing
  pricePerNight   Float
  cleaningFee     Float?           @default(0)
  serviceFee      Float?           @default(0)
  weeklyDiscount  Float?           @default(0)
  monthlyDiscount Float?           @default(0)

  // Amenities (JSON array of strings)
  amenities       Json             @default("[]")

  // Photos (JSON array of photo URLs)
  photos          Json             @default("[]")
  coverPhoto      String?

  // House Rules
  checkInTime     String?          @default("15:00")
  checkOutTime    String?          @default("11:00")
  minNights       Int              @default(1)
  maxNights       Int?
  instantBook     Boolean          @default(false)
  allowPets       Boolean          @default(false)
  allowSmoking    Boolean          @default(false)
  allowEvents     Boolean          @default(false)

  // Status
  status          PropertyStatus   @default(DRAFT)
  isActive        Boolean          @default(true)

  // Admin Review
  reviewedBy      String?          // Admin user ID who reviewed
  reviewedAt      DateTime?
  reviewNotes     String?          @db.Text
  rejectionReason String?          @db.Text

  // Stats
  viewCount       Int              @default(0)
  bookingCount    Int              @default(0)
  averageRating   Float?           @default(0)

  // Timestamps
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  publishedAt     DateTime?
  submittedForReviewAt DateTime?

  // Relations
  host            User             @relation(fields: [hostId], references: [id], onDelete: Cascade)
  bookings        Booking[]
  reviews         Review[]
  favorites       Favorite[]
  approvals       PropertyApproval[]

  @@index([hostId])
  @@index([city])
  @@index([propertyType])
  @@index([status])
  @@map("properties")
}

model Booking {
  id              String         @id @default(cuid())
  propertyId      String
  guestId         String

  // Dates
  checkIn         DateTime
  checkOut        DateTime

  // Pricing
  nightlyRate     Float
  numberOfNights  Int
  subtotal        Float
  cleaningFee     Float          @default(0)
  serviceFee      Float          @default(0)
  totalPrice      Float

  // Guest Info
  guests          Int

  // Status
  status          BookingStatus  @default(PENDING)

  // Payment
  paymentStatus   PaymentStatus  @default(PENDING)
  paymentMethod   String?
  transactionId   String?

  // Timestamps
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  confirmedAt     DateTime?
  cancelledAt     DateTime?
  deletedAt       DateTime?      // Soft delete timestamp

  // Relations
  property        Property       @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  guest           User           @relation(fields: [guestId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([guestId])
  @@index([status])
  @@map("bookings")
}

model Review {
  id              String    @id @default(cuid())
  propertyId      String
  userId          String
  bookingId       String?

  // Ratings (1-5 scale)
  overallRating   Float
  cleanlinessRating Float?
  accuracyRating  Float?
  checkInRating   Float?
  communicationRating Float?
  locationRating  Float?
  valueRating     Float?

  // Content
  comment         String?   @db.Text

  // Host Response
  hostResponse    String?   @db.Text
  hostRespondedAt DateTime?

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  property        Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([userId])
  @@map("reviews")
}

model Favorite {
  id         String   @id @default(cuid())
  userId     String
  propertyId String
  createdAt  DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([userId, propertyId])
  @@index([userId])
  @@map("favorites")
}

// Enums for Property
enum PropertyType {
  HOUSE
  APARTMENT
  VILLA
  CONDO
  TOWNHOUSE
  GUESTHOUSE
  HOTEL
  CABIN
  BUNGALOW
  STUDIO
  LOFT
  OTHER
}

enum RoomType {
  ENTIRE_PLACE
  PRIVATE_ROOM
  SHARED_ROOM
}

enum PropertyStatus {
  DRAFT
  PENDING_REVIEW
  PUBLISHED
  UNLISTED
  SUSPENDED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  REJECTED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

// ============================================================================
// ADMIN & ACCOUNT MANAGER MODELS
// ============================================================================

model Admin {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String   // Hashed with bcrypt
  email     String   @unique
  fullName  String
  role      AdminRole @default(SUPPORT)
  isActive  Boolean  @default(true)

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLogin DateTime?

  // Relations
  activityLogs      AdminActivityLog[]
  assignedComplaints Complaint[] @relation("AssignedTo")
  resolvedComplaints Complaint[] @relation("ResolvedBy")
  chatMessages      ChatMessage[]
  propertyApprovals PropertyApproval[]
  accountActions    AccountAction[]

  @@map("admins")
  @@index([username])
  @@index([email])
  @@index([isActive])
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  SUPPORT
  MODERATOR
}

model AdminActivityLog {
  id          String   @id @default(cuid())
  adminId     String
  action      String
  entityType  String?  // User, Property, Complaint, etc.
  entityId    String?
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  admin       Admin    @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@map("admin_activity_logs")
  @@index([adminId])
  @@index([createdAt])
  @@index([entityType, entityId])
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  BANNED
  DEACTIVATED
}

enum KYCStatus {
  PENDING
  APPROVED
  REJECTED
  REQUIRES_UPDATE
}

model AccountAction {
  id          String   @id @default(cuid())
  userId      String
  adminId     String
  action      AccountActionType
  reason      String
  notes       String?
  metadata    Json?

  createdAt   DateTime @default(now())
  expiresAt   DateTime?

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  admin       Admin    @relation(fields: [adminId], references: [id])

  @@map("account_actions")
  @@index([userId])
  @@index([adminId])
  @@index([action])
  @@index([createdAt])
}

enum AccountActionType {
  SUSPEND
  UNSUSPEND
  BAN
  UNBAN
  VERIFY
  WARN
  KYC_APPROVE
  KYC_REJECT
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  REQUIRES_CHANGES
}

model PropertyApproval {
  id          String   @id @default(cuid())
  propertyId  String
  adminId     String
  status      ApprovalStatus
  comments    String?
  changes     Json?    // Track what was changed

  createdAt   DateTime @default(now())

  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  admin       Admin    @relation(fields: [adminId], references: [id])

  @@map("property_approvals")
  @@index([propertyId])
  @@index([adminId])
  @@index([status])
  @@index([createdAt])
}

// ============================================================================
// COMPLAINTS & SUPPORT
// ============================================================================

model Complaint {
  id          String   @id @default(cuid())
  userId      String
  subject     String
  category    ComplaintCategory
  priority    Priority @default(NORMAL)
  description String
  attachments String[]

  // Status & Assignment
  status      ComplaintStatus @default(OPEN)
  assignedToId String?
  resolvedById String?
  resolution  String?

  // Metadata
  metadata    Json?

  // Audit fields
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  resolvedAt  DateTime?

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  assignedTo  Admin?   @relation("AssignedTo", fields: [assignedToId], references: [id])
  resolvedBy  Admin?   @relation("ResolvedBy", fields: [resolvedById], references: [id])
  messages    ComplaintMessage[]

  @@map("complaints")
  @@index([userId])
  @@index([assignedToId])
  @@index([status])
  @@index([priority])
  @@index([category])
  @@index([createdAt])
}

enum ComplaintCategory {
  BOOKING_ISSUE
  PAYMENT_PROBLEM
  PROPERTY_ISSUE
  HOST_BEHAVIOR
  GUEST_BEHAVIOR
  ACCOUNT_ISSUE
  TECHNICAL_ISSUE
  REFUND_REQUEST
  OTHER
}

enum ComplaintStatus {
  OPEN
  IN_PROGRESS
  WAITING_USER
  WAITING_ADMIN
  RESOLVED
  CLOSED
  ESCALATED
}

enum Priority {
  LOW
  NORMAL
  HIGH
  URGENT
}

model ComplaintMessage {
  id          String   @id @default(cuid())
  complaintId String
  senderId    String   // Can be user ID or admin ID
  senderType  SenderType
  message     String
  attachments String[]
  isInternal  Boolean  @default(false) // Internal admin notes

  createdAt   DateTime @default(now())

  complaint   Complaint @relation(fields: [complaintId], references: [id], onDelete: Cascade)

  @@map("complaint_messages")
  @@index([complaintId])
  @@index([createdAt])
}

enum SenderType {
  USER
  ADMIN
}

// ============================================================================
// CHAT SYSTEM (Real-time support chat)
// ============================================================================

model ChatConversation {
  id          String   @id @default(cuid())
  userId      String
  status      ChatStatus @default(ACTIVE)

  // Metadata
  lastMessageAt DateTime?
  metadata    Json?

  // Audit fields
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  closedAt    DateTime?

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages    ChatMessage[]

  @@map("chat_conversations")
  @@index([userId])
  @@index([status])
  @@index([lastMessageAt])
}

enum ChatStatus {
  ACTIVE
  CLOSED
  ARCHIVED
}

model ChatMessage {
  id             String   @id @default(cuid())
  conversationId String
  senderId       String   // User ID or Admin ID
  senderType     SenderType
  message        String
  attachments    String[]
  isRead         Boolean  @default(false)

  createdAt      DateTime @default(now())

  conversation   ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  admin          Admin?   @relation(fields: [senderId], references: [id])

  @@map("chat_messages")
  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
  @@index([isRead])
}

model SystemMetric {
  id          String   @id @default(cuid())
  metricType  String
  value       Float
  metadata    Json?

  createdAt   DateTime @default(now())

  @@map("system_metrics")
  @@index([metricType])
  @@index([createdAt])
}

