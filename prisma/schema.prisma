// Houseiana Platform - Updated Prisma Schema
// Architecture: Unified User + B2B Organizations + Dual-Role System
// Database: PostgreSQL (Neon Cloud)
// Last Updated: November 21, 2024

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["fullTextSearch"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// CORE USER MODEL (Unified Account System)
// ============================================================================

model User {
  id                       String      @id @default(cuid())

  // Basic Information
  firstName                String
  lastName                 String
  email                    String      @unique
  phone                    String?
  countryCode              String?     @default("+974") // Qatar

  // Authentication
  clerkId                  String?     @unique
  password                 String?     // If not using Clerk
  emailVerified            Boolean     @default(false)
  phoneVerified            Boolean     @default(false)

  // Identity Verification (KYC) - SHARED ACROSS ROLES
  qidNumber                String?     @unique // Qatar ID
  passportNumber           String?     @unique
  idCopyUrl                String?
  kycStatus                KycStatus   @default(PENDING)
  kycVerifiedAt            DateTime?

  // Profile
  profilePhoto             String?
  birthDate                DateTime?
  nationality              String?     @default("Qatar")
  preferredLanguage        String      @default("en")
  preferredCurrency        String      @default("QAR")

  // ROLE FLAGS (Dynamic Assignment)
  isGuest                  Boolean     @default(true)  // Everyone starts as guest
  isHost                   Boolean     @default(false) // Activated on first property
  isAdmin                  Boolean     @default(false)
  isSuperAdmin             Boolean     @default(false)

  // Account Status
  accountStatus            UserStatus  @default(ACTIVE)
  suspendedAt              DateTime?
  suspendedReason          String?
  bannedAt                 DateTime?
  bannedReason             String?

  // Security
  passwordResetToken       String?
  passwordResetExpires     DateTime?
  emailVerificationToken   String?
  emailVerificationExpires DateTime?
  failedLoginAttempts      Int         @default(0)
  accountLockedUntil       DateTime?

  // Payment Integration
  stripeCustomerId         String?     @unique

  // Timestamps
  createdAt                DateTime    @default(now())
  updatedAt                DateTime    @updatedAt
  lastLoginAt              DateTime?

  // PROFILE RELATIONS (Separate data for each role)
  guestProfile             GuestProfile?
  hostProfile              HostProfile?
  hostSettings             HostSettings?

  // AUTHENTICATION RELATIONS
  accounts                 Account[]
  sessions                 Session[]
  otpCodes                 OtpCode[]
  referrals                Referral[]

  // AS GUEST RELATIONS
  bookingsAsGuest          Booking[]   @relation("GuestBookings")
  reviews                  Review[]    @relation("GuestReviews")
  favorites                Favorite[]
  complaintsAsGuest        Complaint[]
  chatConversations        ChatConversation[]

  // AS HOST RELATIONS
  propertiesAsHost         Property[]  @relation("HostProperties")
  bookingsAsHost           Booking[]   @relation("HostBookings")

  // ORGANIZATION MEMBERSHIP (B2B)
  organizationMemberships  OrganizationMember[]

  // ADMIN RELATIONS
  accountActions           AccountAction[]

  // PAYMENT RELATIONS
  paymentMethods           PaymentMethod[]
  payoutMethods            PayoutMethod[]
  transactions             Transaction[]
  payouts                  Payout[]        @relation("HostPayouts")

  // SUPPORT RELATIONS
  supportTickets           SupportTicket[]

  @@index([email])
  @@index([clerkId])
  @@index([qidNumber])
  @@index([passportNumber])
  @@index([accountStatus])
  @@index([kycStatus])
  @@map("users")
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  BANNED
  DEACTIVATED
}

enum KycStatus {
  PENDING
  IN_REVIEW
  APPROVED
  REJECTED
  REQUIRES_UPDATE
}

// Keep for backward compatibility but deprecate
enum UserType {
  HOST
  GUEST
  ADMIN
}

// ============================================================================
// GUEST PROFILE (Separate Travel Data)
// ============================================================================

model GuestProfile {
  id                String   @id @default(cuid())
  userId            String   @unique

  // Travel Preferences
  travelPurpose     String?  // Business, Leisure, Both
  favoriteDestinations String[] @default([])

  // Saved Items
  wishlists         Json?    // Array of wishlist objects

  // Loyalty Program
  travelPoints      Int      @default(0)
  loyaltyTier       LoyaltyTier @default(BRONZE)
  pointsEarned      Int      @default(0)
  pointsRedeemed    Int      @default(0)

  // Stats
  totalBookings     Int      @default(0)
  totalNightsStayed Int      @default(0)
  totalSpent        Float    @default(0)
  averageRating     Float?   // As a guest (rated by hosts)

  // Preferences
  emailNotifications Boolean  @default(true)
  smsNotifications   Boolean  @default(false)
  pushNotifications  Boolean  @default(true)

  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("guest_profiles")
}

enum LoyaltyTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

// ============================================================================
// HOST PROFILE (Separate Hosting Data)
// ============================================================================

model HostProfile {
  id                String   @id @default(cuid())
  userId            String   @unique

  // Host Type
  hostType          HostType @default(INDIVIDUAL)

  // Business Information (Optional for individuals)
  businessName      String?
  businessDescription String? @db.Text

  // Payout Information
  payoutCurrency    String   @default("QAR")
  payoutSchedule    PayoutSchedule @default(WEEKLY)
  minimumPayout     Float    @default(100)

  // Tax Information
  taxId             String?
  taxResidence      String?  @default("Qatar")
  vatRegistered     Boolean  @default(false)
  vatNumber         String?

  // Verification
  isVerifiedHost    Boolean  @default(false)
  verifiedAt        DateTime?
  verificationLevel VerificationLevel @default(BASIC)

  // Host Stats
  totalProperties   Int      @default(0)
  activeProperties  Int      @default(0)
  totalBookings     Int      @default(0)
  totalRevenue      Float    @default(0)
  averageRating     Float?
  totalReviews      Int      @default(0)

  // Performance Metrics
  responseRate      Float?   // % responded within 24h
  responseTime      Int?     // Average minutes to respond
  acceptanceRate    Float?   // % of requests accepted
  cancellationRate  Float?   // % of bookings cancelled by host

  // Settings
  autoAcceptBookings Boolean @default(false)
  instantBookEnabled Boolean @default(false)
  allowPetsDefault   Boolean @default(false)

  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("host_profiles")
}

enum HostType {
  INDIVIDUAL       // Single person, 1-3 properties
  PROFESSIONAL     // Professional host, 4-10 properties
  COMPANY          // Company account (managed via Organization)
}

enum PayoutSchedule {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
}

enum VerificationLevel {
  BASIC           // ID verified
  ENHANCED        // ID + Address verified
  PREMIUM         // ID + Address + Business verified
}

// ============================================================================
// HOST SETTINGS (Notifications & Payout Preferences)
// ============================================================================

model HostSettings {
  id                   String   @id @default(cuid())
  userId               String   @unique

  // Notification Preferences
  emailAlerts          Boolean  @default(true)
  smsAlerts            Boolean  @default(false)
  pushAlerts           Boolean  @default(true)

  // Payout Preferences
  autoPayouts          Boolean  @default(true)
  defaultPayoutMethod  String?  // e.g., "Bank •••• 1022"

  // Timestamps
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("host_settings")
}

// ============================================================================
// ORGANIZATION MODEL (B2B Companies)
// ============================================================================

model Organization {
  id                String   @id @default(cuid())

  // Company Legal Information
  legalName         String
  tradeName         String?
  localName         String?  // Arabic name for Qatar

  // Registration Details
  commercialRegNo   String   @unique // Qatar Commercial Registration
  taxId             String?
  vatNumber         String?
  establishmentDate DateTime?

  // Contact Information
  email             String
  phone             String
  website           String?
  linkedinUrl       String?

  // Physical Address
  country           String   @default("Qatar")
  city              String
  state             String?
  address           String   @db.Text
  postalCode        String?
  buildingNo        String?
  zoneNo            String?  // Qatar specific

  // Business Classification
  businessType      BusinessType
  industryType      IndustryType?
  companySize       CompanySize?

  // Verification & Compliance
  isVerified        Boolean  @default(false)
  verifiedAt        DateTime?
  verifiedBy        String?  // Admin ID
  verificationNotes String?  @db.Text

  // Documents
  commercialLicenseUrl String?
  taxCertificateUrl    String?
  authorizationLetterUrl String?
  additionalDocsUrl    String[] @default([])

  // Branding
  logoUrl           String?
  coverImageUrl     String?
  description       String?  @db.Text
  tagline           String?

  // Platform Settings
  requiresApproval  Boolean  @default(true)
  apiAccessEnabled  Boolean  @default(false)
  apiKey            String?  @unique
  webhookUrl        String?

  // Billing & Finance
  billingEmail      String?
  billingContact    String?
  billingAddress    String?  @db.Text
  paymentTerms      Int      @default(30) // Net 30 days
  creditLimit       Float?

  // Custom Commission (Override platform default)
  customCommission  Boolean  @default(false)
  commissionRate    Float?   // e.g., 15.0 for 15%

  // Organization Stats
  totalProperties   Int      @default(0)
  activeProperties  Int      @default(0)
  totalBookings     Int      @default(0)
  totalRevenue      Float    @default(0)
  averageRating     Float?

  // Status
  status            OrgStatus @default(PENDING_VERIFICATION)
  suspendedAt       DateTime?
  suspendedReason   String?

  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // RELATIONS
  members           OrganizationMember[]
  properties        Property[] @relation("OrgProperties")
  contracts         Contract[]
  invoices          Invoice[]

  @@index([commercialRegNo])
  @@index([status])
  @@index([country, city])
  @@map("organizations")
}

enum BusinessType {
  REAL_ESTATE_COMPANY
  PROPERTY_MANAGEMENT
  HOTEL_GROUP
  SERVICED_APARTMENTS
  VACATION_RENTAL_AGENCY
  REAL_ESTATE_DEVELOPER
  HOSPITALITY_GROUP
  OTHER
}

enum IndustryType {
  REAL_ESTATE
  HOSPITALITY
  TOURISM
  PROPERTY_SERVICES
  OTHER
}

enum CompanySize {
  SMALL           // 1-10 employees
  MEDIUM          // 11-50 employees
  LARGE           // 51-200 employees
  ENTERPRISE      // 200+ employees
}

enum OrgStatus {
  PENDING_VERIFICATION
  VERIFIED
  ACTIVE
  SUSPENDED
  DEACTIVATED
}

// ============================================================================
// ORGANIZATION MEMBER (Team Management for B2B)
// ============================================================================

model OrganizationMember {
  id              String   @id @default(cuid())

  userId          String
  organizationId  String

  // Role & Permissions
  role            OrgRole
  customPermissions Json? // Override default role permissions

  // Department & Title
  department      String?
  jobTitle        String?

  // Status
  status          MemberStatus @default(PENDING)
  invitedAt       DateTime     @default(now())
  joinedAt        DateTime?
  leftAt          DateTime?

  // Invitation
  invitedBy       String?  // User ID who sent invite
  invitationToken String?  @unique

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // RELATIONS
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([organizationId])
  @@index([userId])
  @@index([status])
  @@map("organization_members")
}

enum OrgRole {
  OWNER           // Full control, can delete org, manage billing
  ADMIN           // Can manage team, properties, settings
  MANAGER         // Can manage properties, bookings, reports
  AGENT           // Can edit listings, respond to bookings
  ACCOUNTANT      // View-only for financials
  VIEWER          // Read-only access
}

enum MemberStatus {
  PENDING         // Invitation sent, not accepted
  ACTIVE          // Active member
  SUSPENDED       // Temporarily suspended
  LEFT            // Voluntarily left
  REMOVED         // Removed by admin
}

// ============================================================================
// UPDATED PROPERTY MODEL (Support Individual & Organization Ownership)
// ============================================================================

model Property {
  id              String           @id @default(cuid())

  // OWNERSHIP (Updated)
  ownerId         String           // User ID (individual or org member)
  ownerType       OwnerType
  organizationId  String?          // If owned by organization

  // Basic Information
  title           String
  description     String           @db.Text
  propertyType    PropertyType
  roomType        RoomType

  // Location
  country         String
  city            String
  state           String?
  address         String
  zipCode         String?
  latitude        Float?
  longitude       Float?

  // Capacity
  guests          Int
  bedrooms        Int
  beds            Int
  bathrooms       Float

  // Pricing
  pricePerNight   Float
  cleaningFee     Float?           @default(0)
  serviceFee      Float?           @default(0)
  weeklyDiscount  Float?           @default(0)
  monthlyDiscount Float?           @default(0)

  // Amenities
  amenities       Json             @default("[]")

  // Photos
  photos          Json             @default("[]")
  coverPhoto      String?

  // House Rules
  checkInTime     String?          @default("15:00")
  checkOutTime    String?          @default("11:00")
  minNights       Int              @default(1)
  maxNights       Int?
  instantBook     Boolean          @default(false)
  allowPets       Boolean          @default(false)
  allowSmoking    Boolean          @default(false)
  allowEvents     Boolean          @default(false)

  // Status
  status          PropertyStatus   @default(DRAFT)
  isActive        Boolean          @default(true)

  // Admin Review
  reviewedBy      String?
  reviewedAt      DateTime?
  reviewNotes     String?          @db.Text
  rejectionReason String?          @db.Text

  // Stats
  viewCount       Int              @default(0)
  bookingCount    Int              @default(0)
  averageRating   Float?           @default(0)

  // Timestamps
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  publishedAt     DateTime?
  submittedForReviewAt DateTime?

  // RELATIONS
  owner           User             @relation("HostProperties", fields: [ownerId], references: [id])
  organization    Organization?    @relation("OrgProperties", fields: [organizationId], references: [id])
  bookings        Booking[]        @relation("PropertyBookings")
  reviews         Review[]
  favorites       Favorite[]
  approvals       PropertyApproval[]
  kyc             PropertyKYC?

  @@index([ownerId])
  @@index([organizationId])
  @@index([ownerType])
  @@index([city])
  @@index([propertyType])
  @@index([status])
  @@map("properties")
}

enum OwnerType {
  INDIVIDUAL      // Owned by a person
  ORGANIZATION    // Owned by a company
}

enum PropertyType {
  HOUSE
  APARTMENT
  VILLA
  CONDO
  TOWNHOUSE
  GUESTHOUSE
  HOTEL
  CABIN
  BUNGALOW
  STUDIO
  LOFT
  OTHER
}

enum RoomType {
  ENTIRE_PLACE
  PRIVATE_ROOM
  SHARED_ROOM
}

enum PropertyStatus {
  DRAFT
  PENDING_REVIEW
  PUBLISHED
  UNLISTED
  SUSPENDED
}

// ============================================================================
// BOOKING MODEL
// ============================================================================

model Booking {
  id              String         @id @default(cuid())
  propertyId      String
  guestId         String
  hostId          String         // Denormalized for performance

  // Dates
  checkIn         DateTime
  checkOut        DateTime
  numberOfNights  Int

  // Guests
  guests          Int
  adults          Int
  children        Int            @default(0)
  infants         Int            @default(0)

  // Pricing
  nightlyRate     Float
  subtotal        Float
  cleaningFee     Float          @default(0)
  serviceFee      Float          @default(0)
  taxAmount       Float          @default(0)
  totalPrice      Float

  // Platform Commission
  platformCommission Float
  hostEarnings    Float

  // Status
  status          BookingStatus  @default(PENDING)
  paymentStatus   PaymentStatus  @default(PENDING)
  paymentMethod   String?
  transactionId   String?

  // Guest Details
  specialRequests String?        @db.Text
  arrivalTime     String?

  // Timestamps
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  confirmedAt     DateTime?
  cancelledAt     DateTime?
  completedAt     DateTime?
  deletedAt       DateTime?

  // Cancellation
  cancelledBy     String?        // USER or HOST or ADMIN
  cancellationReason String?

  // RELATIONS
  property        Property       @relation("PropertyBookings", fields: [propertyId], references: [id], onDelete: Cascade)
  guest           User           @relation("GuestBookings", fields: [guestId], references: [id], onDelete: Cascade)
  host            User           @relation("HostBookings", fields: [hostId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([guestId])
  @@index([hostId])
  @@index([status])
  @@map("bookings")
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  REJECTED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

// ============================================================================
// PAYOUT METHOD (For Hosts & Organizations)
// ============================================================================

model PayoutMethod {
  id              String   @id @default(cuid())
  userId          String

  // Payout Type
  type            PayoutType

  // Bank Transfer Details
  bankName        String?
  accountNumber   String?  // Encrypted
  iban            String?
  swiftCode       String?
  accountHolderName String?
  bankAddress     String?

  // Mobile Payment (e.g., Vodafone Cash in Qatar)
  mobileNumber    String?

  // PayPal
  paypalEmail     String?

  // Stripe/Payment Gateway
  stripeAccountId String?

  // Status
  isDefault       Boolean  @default(false)
  isVerified      Boolean  @default(false)
  verifiedAt      DateTime?

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isDefault])
  @@map("payout_methods")
}

enum PayoutType {
  BANK_TRANSFER
  MOBILE_PAYMENT
  PAYPAL
  STRIPE_CONNECT
  WISE
  OTHER
}

// ============================================================================
// CONTRACT MODEL (B2B Service Level Agreements)
// ============================================================================

model Contract {
  id              String   @id @default(cuid())

  organizationId  String

  // Contract Details
  contractNumber  String   @unique
  contractType    ContractType
  title           String
  description     String?  @db.Text

  // Duration
  startDate       DateTime
  endDate         DateTime?
  renewalType     RenewalType @default(MANUAL)

  // Commercial Terms
  customCommissionRate Float?  // Override platform default
  minimumBookings    Int?
  minimumRevenue     Float?
  volumeDiscount     Boolean  @default(false)

  // Service Level Agreement
  slaLevel        SlaLevel @default(STANDARD)
  responseTime    Int?     // Hours
  dedicatedSupport Boolean  @default(false)
  accountManager  String?  // Admin user ID

  // Documents
  signedContractUrl String?
  termsDocumentUrl  String?

  // Signatures
  status          ContractStatus @default(DRAFT)
  orgSignedAt     DateTime?
  orgSignedBy     String?  // User ID from org
  platformSignedAt DateTime?
  platformSignedBy String?  // Admin ID

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organization    Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@index([status])
  @@map("contracts")
}

enum ContractType {
  STANDARD
  PREFERRED_PARTNER
  ENTERPRISE
  CUSTOM
}

enum RenewalType {
  AUTO_RENEW
  MANUAL
  ONE_TIME
}

enum SlaLevel {
  STANDARD
  PREMIUM
  ENTERPRISE
}

enum ContractStatus {
  DRAFT
  PENDING_ORG_SIGNATURE
  PENDING_PLATFORM_SIGNATURE
  ACTIVE
  EXPIRED
  TERMINATED
  SUSPENDED
}

// ============================================================================
// INVOICE MODEL (B2B Billing)
// ============================================================================

model Invoice {
  id              String   @id @default(cuid())

  organizationId  String

  // Invoice Details
  invoiceNumber   String   @unique
  invoiceDate     DateTime @default(now())
  dueDate         DateTime
  period          String   // e.g., "January 2024"

  // Amounts
  subtotal        Float
  taxAmount       Float    @default(0)
  totalAmount     Float

  // Line Items
  lineItems       Json     // Array of items

  // Payment
  status          InvoiceStatus @default(PENDING)
  paidAt          DateTime?
  paymentMethod   String?
  paymentReference String?

  // Documents
  pdfUrl          String?

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organization    Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@index([status])
  @@map("invoices")
}

enum InvoiceStatus {
  DRAFT
  PENDING
  PAID
  OVERDUE
  CANCELLED
  REFUNDED
}

// ============================================================================
// KEEP EXISTING MODELS (Review, Favorite, etc.)
// ============================================================================

model Review {
  id              String    @id @default(cuid())
  propertyId      String
  userId          String
  bookingId       String?

  // Ratings
  overallRating   Float
  cleanlinessRating Float?
  accuracyRating  Float?
  checkInRating   Float?
  communicationRating Float?
  locationRating  Float?
  valueRating     Float?

  // Content
  comment         String?   @db.Text

  // Host Response
  hostResponse    String?   @db.Text
  hostRespondedAt DateTime?

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  property        Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user            User      @relation("GuestReviews", fields: [userId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([userId])
  @@map("reviews")
}

model Favorite {
  id         String   @id @default(cuid())
  userId     String
  propertyId String
  createdAt  DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([userId, propertyId])
  @@index([userId])
  @@map("favorites")
}

// ============================================================================
// AUTHENTICATION MODELS
// ============================================================================

model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  refreshToken String?  @unique
  expiresAt    DateTime
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model OtpCode {
  id        String   @id @default(cuid())
  userId    String?
  phone     String?
  email     String?
  code      String
  type      OtpType
  expiresAt DateTime
  verified  Boolean  @default(false)
  attempts  Int      @default(0)
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("otp_codes")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

enum OtpType {
  PHONE_VERIFICATION
  EMAIL_VERIFICATION
  LOGIN
  PASSWORD_RESET
}

model Referral {
  id        String   @id @default(cuid())
  userId    String
  code      String   @unique
  usedBy    String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("referrals")
}

// ============================================================================
// ADMIN & MODERATION MODELS
// ============================================================================

model Admin {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String
  email     String   @unique
  fullName  String
  role      AdminRole @default(SUPPORT)
  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLogin DateTime?

  activityLogs      AdminActivityLog[]
  assignedComplaints Complaint[] @relation("AssignedTo")
  resolvedComplaints Complaint[] @relation("ResolvedBy")
  chatMessages      ChatMessage[]
  propertyApprovals PropertyApproval[]
  accountActions    AccountAction[]

  @@map("admins")
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  SUPPORT
  MODERATOR
}

model AdminActivityLog {
  id          String   @id @default(cuid())
  adminId     String
  action      String
  entityType  String?
  entityId    String?
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  admin       Admin    @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@map("admin_activity_logs")
}

model AccountAction {
  id          String   @id @default(cuid())
  userId      String
  adminId     String
  action      AccountActionType
  reason      String
  notes       String?
  metadata    Json?

  createdAt   DateTime @default(now())
  expiresAt   DateTime?

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  admin       Admin    @relation(fields: [adminId], references: [id])

  @@map("account_actions")
}

enum AccountActionType {
  SUSPEND
  UNSUSPEND
  BAN
  UNBAN
  VERIFY
  WARN
  KYC_APPROVE
  KYC_REJECT
}

model PropertyApproval {
  id          String   @id @default(cuid())
  propertyId  String
  adminId     String
  status      ApprovalStatus
  comments    String?
  changes     Json?

  createdAt   DateTime @default(now())

  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  admin       Admin    @relation(fields: [adminId], references: [id])

  @@map("property_approvals")
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  REQUIRES_CHANGES
}

// ============================================================================
// SUPPORT & COMPLAINTS
// ============================================================================

model Complaint {
  id          String   @id @default(cuid())
  userId      String
  subject     String
  category    ComplaintCategory
  priority    Priority @default(NORMAL)
  description String
  attachments String[]

  status      ComplaintStatus @default(OPEN)
  assignedToId String?
  resolvedById String?
  resolution  String?

  metadata    Json?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  resolvedAt  DateTime?

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  assignedTo  Admin?   @relation("AssignedTo", fields: [assignedToId], references: [id])
  resolvedBy  Admin?   @relation("ResolvedBy", fields: [resolvedById], references: [id])
  messages    ComplaintMessage[]

  @@map("complaints")
}

enum ComplaintCategory {
  BOOKING_ISSUE
  PAYMENT_PROBLEM
  PROPERTY_ISSUE
  HOST_BEHAVIOR
  GUEST_BEHAVIOR
  ACCOUNT_ISSUE
  TECHNICAL_ISSUE
  REFUND_REQUEST
  OTHER
}

enum ComplaintStatus {
  OPEN
  IN_PROGRESS
  WAITING_USER
  WAITING_ADMIN
  RESOLVED
  CLOSED
  ESCALATED
}

enum Priority {
  LOW
  NORMAL
  HIGH
  URGENT
}

model ComplaintMessage {
  id          String   @id @default(cuid())
  complaintId String
  senderId    String
  senderType  SenderType
  message     String
  attachments String[]
  isInternal  Boolean  @default(false)

  createdAt   DateTime @default(now())

  complaint   Complaint @relation(fields: [complaintId], references: [id], onDelete: Cascade)

  @@map("complaint_messages")
}

enum SenderType {
  USER
  ADMIN
}

// ============================================================================
// CHAT SYSTEM
// ============================================================================

model ChatConversation {
  id          String   @id @default(cuid())
  userId      String
  status      ChatStatus @default(ACTIVE)

  lastMessageAt DateTime?
  metadata    Json?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  closedAt    DateTime?

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages    ChatMessage[]

  @@map("chat_conversations")
}

enum ChatStatus {
  ACTIVE
  CLOSED
  ARCHIVED
}

model ChatMessage {
  id             String   @id @default(cuid())
  conversationId String
  senderId       String
  senderType     SenderType
  message        String
  attachments    String[]
  isRead         Boolean  @default(false)

  createdAt      DateTime @default(now())

  conversation   ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  admin          Admin?   @relation(fields: [senderId], references: [id])

  @@map("chat_messages")
}

// ============================================================================
// PAYMENT MODELS
// ============================================================================

model PaymentMethod {
  id          String   @id @default(cuid())
  userId      String
  brand       String
  last4       String
  expiry      String
  isDefault   Boolean  @default(false)

  stripePaymentMethodId String? @unique

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payment_methods")
}

model Transaction {
  id            String   @id @default(cuid())
  userId        String
  bookingId     String?

  description   String
  amount        Float
  status        TransactionStatus @default(PAID)
  type          TransactionType

  paymentMethod String

  stripeChargeId String? @unique
  stripeRefundId String? @unique

  date          DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("transactions")
}

enum TransactionStatus {
  PAID
  PENDING
  REFUNDED
  FAILED
}

enum TransactionType {
  PAYMENT
  REFUND
}

model SystemMetric {
  id          String   @id @default(cuid())
  metricType  String
  value       Float
  metadata    Json?

  createdAt   DateTime @default(now())

  @@map("system_metrics")
}

// ============================================================================
// SUPPORT MODELS
// ============================================================================

model SupportTicket {
  id              String        @id @default(cuid())
  userId          String
  category        TicketCategory
  subject         String
  priority        TicketPriority @default(MEDIUM)
  status          TicketStatus   @default(OPEN)

  bookingId       String?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  closedAt        DateTime?

  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages        SupportMessage[]

  @@map("support_tickets")
}

model SupportMessage {
  id              String   @id @default(cuid())
  ticketId        String
  senderId        String
  senderRole      MessageSenderRole
  content         String
  attachments     String[]

  createdAt       DateTime @default(now())

  ticket          SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@map("support_messages")
}

enum TicketCategory {
  BOOKING_ISSUE
  PAYMENT
  ACCOUNT
  TECHNICAL
  GENERAL
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_USER
  RESOLVED
  CLOSED
}

enum MessageSenderRole {
  USER
  SUPPORT
  SYSTEM
}

// ============================================================================
// PROPERTY KYC VERIFICATION (Host Console UI)
// ============================================================================

model PropertyKYC {
  id              String   @id @default(cuid())
  propertyId      String   @unique

  // Host Identity
  hostName        String
  hostIdType      String?  // QID, Passport, etc.
  hostIdNumber    String?
  hostIdExpiry    DateTime?
  hostDob         DateTime?

  // Company Details (if applicable)
  companyName     String?
  crNumber        String?  // Commercial Registration
  crExpiry        DateTime?

  // Documents
  idDocument      String?  // URL to uploaded document
  deedDocument    String?  // Property deed
  utilityDocument String?  // Utility bill

  // Verification Status
  verificationStatus KycStatus @default(PENDING)
  verifiedAt      DateTime?
  verifiedBy      String?  // Admin ID
  rejectionReason String?  @db.Text

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  property        Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([verificationStatus])
  @@map("property_kyc")
}

// ============================================================================
// PAYOUT MODEL (Host Earnings)
// ============================================================================

model Payout {
  id              String   @id @default(cuid())
  hostId          String   // User ID of the host

  // Payout Details
  amount          Float
  currency        String   @default("QAR")
  status          PayoutStatus @default(SCHEDULED)
  method          String?  // Bank Transfer, Mobile Payment, etc.

  // Period
  periodStart     DateTime?
  periodEnd       DateTime?

  // Scheduling
  scheduledDate   DateTime?
  paidDate        DateTime?

  // Payment Reference
  referenceId     String?
  transactionId   String?

  // Metadata
  bookingIds      String[] // Array of booking IDs included in this payout
  metadata        Json?

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  host            User     @relation("HostPayouts", fields: [hostId], references: [id], onDelete: Cascade)

  @@index([hostId])
  @@index([status])
  @@index([scheduledDate])
  @@map("payouts")
}

enum PayoutStatus {
  SCHEDULED
  PROCESSING
  PAID
  FAILED
  CANCELLED
}
